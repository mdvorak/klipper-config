[gcode_macro PREHEAT_CHAMBER]
variable_default_target: 35
gcode:
    {% set target = params.TARGET|default(printer['gcode_macro PREHEAT_CHAMBER']['default_target'])|float %}
    {% set bed = params.BED|default(110)|float %}
    {% set extruder = params.EXTRUDER|default(150)|float %}
    {% set z = params.Z|default(40)|float %}
    {% set wait = params.WAIT|default(1)|int %}

    {% set th = printer.toolhead %}
    {% set fan_speed = 255 %}

    SAVE_GCODE_STATE NAME=preheat_chamber

    M118 Preheating chamber to {target} C

    ; Set exhaust to minimum, just enough to force air to move thru filter
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0.08

    ; Start heating
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder}

    ; Home
    {% if printer.toolhead.homed_axes != "xyz" %}
      G32
    {% endif %}

    ; Move to position
    PARK_CENTER Z={z}

    ; Enable fan
    M106 S{fan_speed}

    {% if wait != 0 %}
      ; Wait for chamber temperature
      ; NOTE that this command does not have timeout, therefore it might run indefinitely
      TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target}
    {% endif %}

    ; Restore
    RESTORE_GCODE_STATE NAME=preheat_chamber
