[gcode_macro PARK]
gcode:
    {% set Z_HOP = params.Z_HOP|default(5)|float %}
    {% set th = printer.toolhead %}
    {% set max_z = th.axis_maximum.z|float %}
    {% set act_x = th.position.x|float %}
    {% set act_y = th.position.y|float %}
    {% set act_z = th.position.z|float %}

    {% set target_x = params.X|default(th.axis_maximum.x - 4)|float %}
    {% set target_y = params.Y|default(th.axis_maximum.y - 4)|float %}
    {% set target_z = params.Z|default(20)|float %}

    {% if act_z < (max_z - Z_HOP) %}
    {% set z_safe = Z_HOP %}
    {% else %}
    {% set z_safe = max_z - act_z %}
    {% endif %}

    {% if act_x != target_x or act_y != target_y %}
    G91
    G0 Z{z_safe} F3000
    {% endif %}

    G90
    G0 X{target_x} Y{target_y} F10000
    G0 Z{target_z} F3000

[gcode_macro PARK_CENTER]
gcode:
    {% set th = printer.toolhead %}
    PARK X=125 Y=125 Z=60
