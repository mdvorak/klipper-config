[gcode_macro PARK]
gcode:
    {% set th = printer.toolhead %}
    {% set max_z = th.axis_maximum.z|float %}
    {% set act_z = th.position.z|float %}

    {% if act_z < (max_z - Z_HOP) %}
    {% set z_safe = Z_HOP %}
    {% else %}
    {% set z_safe = max_z - act_z %}
    {% endif %}

    G91
    G0 Z{z_safe} F3000
    G90
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y//2} F10000
    G0 Z30 F3000
