[gcode_macro PARK]
gcode:
    {% set th = printer.toolhead %}

    {% set Z_HOP = params.Z_HOP|default(5)|float %}
    {% set target_x = params.X|default(th.axis_maximum.x - 4)|float %}
    {% set target_y = params.Y|default(th.axis_maximum.y)|float %}
    {% set target_z = params.Z|default(20)|float %}

    {% set max_z = th.axis_maximum.z|float %}
    {% set act_x = th.position.x|float %}
    {% set act_y = th.position.y|float %}
    {% set act_z = th.position.z|float %}

    SAVE_GCODE_STATE NAME=park

    {% if printer.toolhead.homed_axes != "xyz" %}
    G28
    QUAD_GANTRY_LEVEL
    G0 X{th.axis_maximum.x-5} Y{th.axis_maximum.y-5} F20000
    G28
    {% endif %}

    {% set movement_z = act_z + Z_HOP %}

    {% if movement_z < target_z %}
    {% set movement_z = target_z %}
    {% endif %}

    {% if movement_z > max_z %}
    {% set movement_z = max_z %}
    {% endif %}

    {% if act_x != target_x or act_y != target_y %}
    G90
    G0 Z{movement_z} F3000
    {% endif %}

    G90
    G0 X{target_x} Y{target_y} F10000
    G0 Z{target_z} F3000

    RESTORE_GCODE_STATE NAME=park

[gcode_macro PARK_CENTER]
gcode:
    {% set target_z = params.Z|default(60)|float %}

    PARK X=125 Y=125 Z={target_z}

[gcode_macro PARK_PURGE]
gcode:
    _WIPE_NOZZLE_START
