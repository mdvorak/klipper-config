[gcode_macro PARK]
gcode:
    {% set th = printer.toolhead %}

    {% set Z_HOP = params.Z_HOP|default(5)|float %}
    {% set target_x = params.X|default(th.axis_maximum.x - 4)|float %}
    {% set target_y = params.Y|default(th.axis_maximum.y - 1)|float %}
    {% set target_z = params.Z|default(20)|float %}

    {% set max_z = th.axis_maximum.z|float %}
    {% set current_x = th.position.x|float %}
    {% set current_y = th.position.y|float %}
    {% set current_z = th.position.z|float %}

    _OPTIONAL_G32

    {% set movement_z = current_z + Z_HOP %}

    {% if movement_z < target_z %}
    {% set movement_z = target_z %}
    {% endif %}

    {% if movement_z > max_z %}
    {% set movement_z = max_z %}
    {% endif %}

    {% if current_x != target_x or current_y != target_y %}
    G90
    G0 Z{movement_z} F3000
    {% endif %}

    G90
    G0 X{target_x} Y{target_y} F10000
    G0 Z{target_z} F3000

[gcode_macro PARK_CENTER]
gcode:
    {% set target_z = params.Z|default(60)|float %}
    PARK X=125 Y=125 Z={target_z}

[gcode_macro PARK_PURGE]
gcode:
    _OPTIONAL_G32
    _WIPE_POSITION {rawparams}
