[gcode_macro REWIND_START]
variable_rotation_distance: 63
variable_speed_slow: 30
variable_speed_fast: 80
variable_timeout: 15 ; seconds
gcode:
    {% set speed = params.SPEED|float %}
    {% set tool = params.TOOL|int %}
    {% set timeout = printer['gcode_macro REWIND_START']['timeout']|float %}

    {% if tool > -1 %}
    M118 Rewinding T{tool}

    UPDATE_DELAYED_GCODE ID=rewind_off DURATION={timeout}
    SET_PIN PIN=_rewind{tool}_enable VALUE=1
    _REWIND_SET_SPEED TOOL={tool} SPEED={speed}
    {% endif %}

[gcode_macro REWIND_START_SLOW]
gcode:
    {% set tool = params.TOOL|default(printer.ercf.tool)|int %}
    {% set speed = printer['gcode_macro REWIND_START']['speed_slow']|float %}

    REWIND_START TOOL={tool} SPEED={speed}

[gcode_macro REWIND_START_FAST]
gcode:
    {% set tool = params.TOOL|default(printer.ercf.tool)|int %}
    {% set speed = printer['gcode_macro REWIND_START']['speed_fast']|float %}

    REWIND_START TOOL={tool} SPEED={speed}

[gcode_macro REWIND_STOP]
gcode:
    UPDATE_DELAYED_GCODE ID=rewind_off DURATION=0

    {% for tool in range(12) %}
    {% set pin_name = ('output_pin _rewind%d_enable' % tool) %}
    {% if pin_name in printer and printer[pin_name].value %}
        M118 Stopping rewinding of T{tool}

        SET_PIN PIN=_rewind{tool}_enable VALUE=0
        SET_PIN PIN=_rewind{tool}_step VALUE=0
    {% endif %}
    {% endfor %}

[gcode_macro _REWIND_SET_SPEED]
gcode:
    {% set speed = params.SPEED|float %}
    {% set tool = params.TOOL|int %}

    {% set rotation_distance = printer['gcode_macro REWIND_START']['rotation_distance']|float %}
    {% set cycle_time = 1 / (speed * rotation_distance) %}

    SET_PIN PIN=_rewind{tool}_step VALUE=.5 CYCLE_TIME={cycle_time}

[delayed_gcode rewind_off]
gcode:
    REWIND_STOP
