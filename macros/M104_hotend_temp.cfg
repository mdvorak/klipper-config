[gcode_macro M104]
rename_existing: M104.0
gcode:
    ; Parameters
    {% set temp = params.S|float %}
    {% set tool = params.T|default(-1)|int %}

    {% if tool >= 0 %}
        ; MMU mode - set only if it equals current tool
        {% if tool == printer.mmu.tool %}
            M104.0 S{temp}
        {% endif %}
    {% else %}
        ; Normal mode
        M104.0 S{temp}
    {% endif %}

    {% if temp > 0 and printer.idle_timeout.state != "Printing" %}
        STATUS_HEATING
    {% endif %}
