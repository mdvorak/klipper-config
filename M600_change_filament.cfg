# filament change
[gcode_macro M600]
gcode:
    M117 Filament Change
    M118 Filament Change
    SAVE_GCODE_STATE NAME=filament_change
    LOW_TEMP_CHECK
    
    {% if printer.toolhead.homed_axes != "xyz" %}
      G28
    {% endif %}
    
    G91 # relative
    G1 E-0.4 F1000 # retract a bit
    G1 Z-0.4 F10000 # z-hop
    G1 E-2 F600 # retract more
    M125 # park
    M702 # unload

    M117 Feed new filament now!
    M118 Feed new filament now!
    PAUSE

    M117 Resuming
    M118 Resuming
    RESTORE_GCODE_STATE NAME=filament_change
    M117 Printing..
    M118 Printing..
