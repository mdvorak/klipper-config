[gcode_macro PURGE_FILAMENT]
gcode:
    {% set R = params.R|default(0)|float %}

    SAVE_GCODE_STATE NAME=PURGE_FILAMENT
    M117 Purging Filament
    LOW_TEMP_CHECK W=0
    M125
    LOW_TEMP_CHECK
    G91
    G1 Z20 F1000
    G1 E20 F100
    {% if R > 0 %}
      G92 E0.0
      G1 E-{R} F600 ; retract
    {% endif %}
    G92 E0.0
    G1 Z-20 F1000
    RESTORE_GCODE_STATE NAME=PURGE_FILAMENT
