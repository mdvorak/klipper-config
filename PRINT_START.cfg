# load filament
[gcode_macro PRINT_START]
gcode:
  {% set NOZZLE_TEMP = params.NOZZLE_TEMP|int %}
  {% set BED_TEMP = params.BED_TEMP|int %}
  {% set BED_MESH = params.BED_BESH|default(1)|int %}
  
  # Heatup sequence
  M117 Heating up the bed
  M118 Heating up the bed
 
  {% if BED_TEMP >= 100 and printer.extruder.temperature < BED_TEMP - 10 %}
  M190 S{BED_TEMP - 10} ; partial bed warmup
  {% elif BED_TEMP >= 80 and printer.extruder.temperature < BED_TEMP - 20 %}
  M190 S{BED_TEMP - 20} ; partial bed warmup
  {% endif %}
  
  M104 S150 ; nozzle warmup
  M190 S{BED_TEMP} ; wait for bed temp to stabilize
  
  M117 Homing
  M118 Homing
  G90 ; use absolute coordinates
  M83 ; extruder relative mode
  
  G28 ; home all axis
  
  {% if BED_MESH > 0 %}
  G29 ; Klipper mesh macro
  {% endif %}
  
  # move nozzle to the side so it can be wiped, and also ooze outside bed
  M117 Heating up the nozzle
  M118 Heating up the nozzle
  M104 S{NOZZLE_TEMP} ; heat nozzle
  
  G1 X244 Y40 F5000
  G1 Z0.28 F240
  
  M109 S{NOZZLE_TEMP} ; wait for nozzle temp to stabilize
  
  # wipe nozzle at bed side
  M117 Wipe nozzle
  M118 Wipe nozzle
  G92 E0
  G1 E10 F200
  G92 E0
  G1 E-2 F200
  G1 X225 F5000
  G1 Z5 F300
  
  # prime start
  M117 Priming
  M118 Priming
  G1 X2 Y30 F5000
  G1 Z0.28 F240
  G92 E0
  G1 Y160 E10 F1500 ; prime the nozzle
  G1 X2.3 F5000
  G92 E0
  G1 Y30 E10 F1200 ; prime the nozzle
  G92 E0

  M117 Starting print
  M118 Starting print
